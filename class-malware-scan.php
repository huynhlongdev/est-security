<?php
if (!defined('ABSPATH')) exit;

/**
 * 1. relative
 * 2. get_all_files
 * 3. build_baseline
 * 4. core_updated
 * 5. schedule_daily_23h
 * 6. remove_file
 * 7. scheduled_scan
 * 8. run_scan
 */
class LP_Scan_Malware
{
    private $option_key     = 'est_baseline';
    private $report_option  = 'est_last_report';
    private $cron_hook      = 'est_daily_scan';
    // File extensions to skip during scanning
    private $skip_extensions = [
        'log',
        'png',
        'jpg',
        'jpeg',
        'gif',
        'svg',
        'ico',
        'webp',
        'bmp',
        'tiff',
        'mp4',
        'mp3',
        'avi',
        'mov',
        'wmv',
        'flv',
        'mkv',
        'pdf',
        'doc',
        'docx',
        'xls',
        'xlsx',
        'ppt',
        'pptx',
        'woff',
        'woff2',
        'eot',
        'ttf',
        'otf',
        'po',
        'mo',
        'pot',
        'zip',
        'rar',
        '7z',
        'tar',
        'gz'
    ];

    // Paths to ignore during scanning
    private $ignore_paths = [
        'wp-content/cache',
        'wp-content/uploads',
        'wp-content/backups',
        'wp-content/updraft',
        '.git',
        'node_modules'
    ];

    // Files to remove for security
    private $files_to_remove = [
        ABSPATH . 'readme.html',
        ABSPATH . 'license.txt',
        ABSPATH . 'phpinfo.php',
        ABSPATH . 'wp-config-sample.php'
    ];

    public function __construct()
    {
        // Cron event
        add_action($this->cron_hook, [$this, 'scheduled_scan']);

        // Kiểm tra baseline nếu chưa có → tự động tạo ngay
        add_action('init', [$this, 'init_actions']);

        add_action('core_updated_successfully', [$this, 'core_updated']);

        // Lên lịch cron nếu chưa có
        if (!wp_next_scheduled($this->cron_hook)) {
            $this->schedule_daily_23h();
        }
    }

    public function init_actions()
    {
        $baseline = get_option($this->option_key, false);
        if ($baseline === false || empty($baseline)) {
            update_option($this->option_key, $this->build_baseline());
        }

        $report = get_option($this->report_option, false);
        if ($report === false || empty($report)) {
            update_option($this->report_option, $this->run_scan());
        }

        $this->remove_file();
    }

    // Chuyển đổi đường dẫn tuyệt đối thành đường dẫn tương đối từ ABSPATH
    private function relative($abs_path)
    {
        $abs = str_replace('\\', '/', $abs_path);
        $base = str_replace('\\', '/', ABSPATH);
        if (strpos($abs, $base) === 0) {
            return ltrim(substr($abs, strlen($base)), '/');
        }
        return $abs;
    }

    // Lấy tất cả file trong thư mục, bỏ qua các file/đường dẫn không cần thiết
    private function get_all_files($dir)
    {
        $files = [];
        try {
            $rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir, RecursiveDirectoryIterator::SKIP_DOTS));
            foreach ($rii as $file) {
                $path = $file->getPathname();

                // Bỏ qua các đường dẫn không cần thiết
                if (in_array($path, $this->ignore_paths)) continue;

                // Bỏ qua các file có đuôi không cần thiết
                $ext = pathinfo($path, PATHINFO_EXTENSION);

                if (in_array(strtolower($ext), $this->skip_extensions)) continue;

                // Thêm file vào danh sách
                if (is_file($path)) $files[] = $path;
            }
        } catch (Exception $e) {
            error_log('Malware Scanner Error: ' . $e->getMessage());
        }

        return $files;
    }

    // Xây dựng baseline dựa trên filemtime của tất cả file trong core + wp-content
    private function build_baseline()
    {
        $baseline = [];
        $files = $this->get_all_files(ABSPATH);
        foreach ($files as $f) {
            if (!is_readable($f)) continue;
            $baseline[$this->relative($f)] = filemtime($f);
        }

        return $baseline;
    }

    function core_updated($wp_version)
    {
        $this->remove_file();
        $this->build_and_update_baseline();
    }

    private function build_and_update_baseline()
    {
        update_option($this->option_key, $this->build_baseline());
    }

    private function schedule_daily_23h()
    {
        $timezone = wp_timezone();
        $now = new DateTime('now', $timezone);
        $run_time = new DateTime('23:00', $timezone);

        if ($now > $run_time) {
            $run_time->modify('+1 day');
        }

        wp_schedule_event($run_time->getTimestamp(), 'daily', $this->cron_hook);
    }

    public function remove_file()
    {
        foreach ($this->files_to_remove as $file) {
            if (file_exists($file)) {
                @unlink($file);
            }
        }
    }

    // Quét theo lịch trình cron
    public function scheduled_scan()
    {
        $report = $this->run_scan();
        update_option($this->report_option, $report);

        // Delete file
        $this->remove_file();

        if ($report['counts']['modified'] == 0 && $report['counts']['added'] == 0) {
            return;
        }

        if (!empty(get_option('sfcd_notify_email')) && is_email(get_option('sfcd_notify_email'))) {
            $template_path = plugin_dir_path(__FILE__) . 'templates/mail-template.html';
            $template = file_get_contents($template_path);
            $template = str_replace([
                '{{domain}}',
                '{{time}}',
                '{{total_scanned}}',
                '{{modified_count}}',
                '{{added_count}}',
                '{{details}}'
            ], [
                site_url(),
                $report['time'],
                $report['counts']['total_scanned'],
                $report['counts']['modified'],
                $report['counts']['added'],
                $report['details']
            ], $template);

            $sent = wp_mail(
                get_option('sfcd_notify_email'),
                'File Change Detector Report',
                $template,
                ['Content-Type: text/html; charset=UTF-8']
            );

            if ($sent) {
                // Sau khi gửi mail thành công → update baseline
                $new_baseline = $this->build_baseline();
                update_option($this->option_key, $new_baseline);

                // Reset report cho lần sau
                update_option($this->report_option, []);
            }
        }
    }

    // Chạy quét và trả về báo cáo
    private function run_scan()
    {
        $baseline = get_option($this->option_key, []);
        $dirs = [ABSPATH];
        $files = [];
        foreach ($dirs as $dir) {
            $files = array_merge($files, $this->get_all_files($dir));
        }

        $modified = 0;
        $added = 0;
        $details = [];

        foreach ($files as $f) {
            $rel = $this->relative($f);
            $mtime = filemtime($f);
            // $mtime_human = date_i18n('Y-m-d H:i:s', $mtime);
            $mtime_human = date_i18n('Y-m-d H:i:s');

            if (isset($baseline[$rel])) {
                if ($mtime != $baseline[$rel]) {
                    $modified++;
                    $details[] = "[MODIFIED] - [{$mtime_human}] $rel";
                }
            } else {
                $added++;
                $details[] = "[NEW] - [{$mtime_human}] $rel";
            }
        }

        $report = [
            'time' => date_i18n('Y-m-d H:i:s'),
            'counts' => [
                'added' => $added,
                'modified' => $modified,
                'total_scanned' => count($files),
            ],
            'details' => implode("\n", $details),
        ];

        return $report;
    }
}

$malware = new LP_Scan_Malware();
